require 'bundler/gem_tasks'

def get_definitions
  lines = File.readlines(File.expand_path('../../C++/include/Shared.h', __FILE__))
  buf = ['module Smith']
  lines.each do |line|
    m = line.match(/#define\s+(.+?)\b\W+"(.+?)"/)
    if m && (key = m[1]) && (value = m[2])
      buf << "  #{key} = '#{value}'"
    end
  end
  buf << 'end'
  buf.join("\n")
end

def definition_file
  File.expand_path('../lib/smith/definitions.rb', __FILE__)
end

desc 'Generate constant definition file using preprocessor definitions from C++ header files'
task :import_definitions do
  if (definitions = get_definitions) == File.read(definition_file)
    puts 'Definition file is up to date'
  else
    puts 'Updating definition file'
    begin
      File.write(definition_file, definitions)
    rescue Errno::EACCES
      abort("#{definition_file} is not writable, ensure write access before continuing")
    end
    puts 'Successfully imported constant definitions'
  end
end

task :check_definitions do
  if get_definitions != File.read(definition_file)
    abort('definitions.rb is not up to date. Run "rake import_definitions" before continuing')
  end
end

desc 'Deploy to beaglebone'
task deploy: [:check_definitions, :build] do
  puts "Deploying Smith version #{Smith::VERSION}"

  if Gem.win_platform?
    puts('Unable to run "bundle package" automatically, invoke manually if any new dependencies have been added')
  else
    # Package dependencies into vendor/cache on the localhost
    system '/usr/bin/env RUBYOPT= bundle package --all'
    abort('bundle package failed, aborting') if $?.to_i != 0
  end

  # Set paths
  local_root_dir = File.expand_path('..', __FILE__)
  remote_cache_parent_dir = '/root'
  local_cache_dir = File.join(local_root_dir, 'vendor/cache')
  remote_cache_dir = File.join(remote_cache_parent_dir, File.basename(local_cache_dir))
  gem_file = File.join(local_root_dir, 'pkg', "smith-#{Smith::VERSION}.gem")

  require 'sshkit'
  require 'sshkit/dsl'

  host = SSHKit::Host.new('root@192.168.7.2')
  host.ssh_options = { paranoid: false }
  host.password = 'root'

  on host do
    # Clean
    execute "rm -rf #{remote_cache_dir}"

    # Make sure the target directory exists
    execute "mkdir -p #{remote_cache_parent_dir}"

    # Upload the dependencies
    upload! local_cache_dir, remote_cache_parent_dir, recursive: true

    # Upload the gem
    upload! gem_file, remote_cache_dir

    # Uninstall old versions
    execute 'gem uninstall smith -ax'

    # Install the gem using local copies of dependencies
    within remote_cache_dir do
      options = ['install', File.basename(gem_file)]
      options << '--local'
      options << '--no-rdoc --no-ri'
      execute :gem, options
    end

  end

end

